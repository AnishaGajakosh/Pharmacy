<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=2">
  <title>Checkout - CareKart</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">CareKart</a>
    <div class="titlebar">Safe medicines • Fast delivery</div>
  </div>
</header>
<main class="container">
  <h1>Checkout</h1>

  <form id="checkoutForm" class="checkout-form">
    <h3>Shipping Information</h3>
    <input type="text" name="name" placeholder="Full Name" required>
    <input type="text" name="address" placeholder="Address" required>
    <input type="text" name="city" placeholder="City" required>
    <input type="text" name="state" placeholder="State" required>
    <input type="text" name="zip" placeholder="ZIP Code" required>
    <input type="text" name="phone" placeholder="Phone" required>

    <h3>Payment Method</h3>
    <select name="paymentMethod" required>
      <option value="cod">Cash on Delivery</option>
      <option value="card">Credit/Debit Card</option>
      <option value="upi">UPI</option>
    </select>

    <button type="submit" class="btn-add">Place Order</button>
  </form>
</main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const API_BASE = "https://pharmacy-oszy.onrender.com";

  function getCartTotal() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  }

  const form = document.getElementById("checkoutForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const user = JSON.parse(localStorage.getItem("user") || "null");
    const token = localStorage.getItem("token");
    if (!user || !token) {
      alert("Please login to continue checkout.");
      window.location.href = "login.html";
      return;
    }

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) {
      alert("Your cart is empty.");
      return;
    }

    const shipping = Object.fromEntries(new FormData(form));
    const paymentMethod = shipping.paymentMethod;
    delete shipping.paymentMethod;

    const totalAmount = getCartTotal();

    if (paymentMethod === "cod") {
      placeOrder(cart, shipping, "cod");
    } else {
      try {
        const res = await fetch(`${API_BASE}/api/payments/create-order`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ amount: totalAmount })
        });

        const data = await res.json();
        if (!data.ok) return alert("Payment initialization failed");

        const options = {
          key: data.key,
          amount: data.order.amount,
          currency: "INR",
          name: "A1 Medical",
          description: "Order Payment",
          order_id: data.order.id,
          handler: async function (response) {
            try {
              const verifyRes = await fetch(`${API_BASE}/api/payments/verify`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature,
                  items: cart,
                  shipping,
                  amount: totalAmount,
                  paymentId: data.paymentId
                })
              });
              const verifyData = await verifyRes.json();
              if (verifyData.ok) {
                localStorage.removeItem("cart");
                window.location.href = `order-confirmation.html?id=${verifyData.orderId}`;
              } else {
                alert(verifyData.msg || "Payment verification failed");
              }
            } catch (err) {
              console.error(err);
              alert("Error verifying payment");
            }
          },
          prefill: { name: shipping.name, email: user.email || "", contact: shipping.phone },
          theme: { color: "#28a745" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error(err);
        alert("Error initializing payment");
      }
    }
  });

  async function placeOrder(cart, shipping, paymentMethod) {
    try {
      const res = await fetch(`${API_BASE}/api/orders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ items: cart, shipping, paymentMethod })
      });

      const data = await res.json();
      if (data.ok) {
        localStorage.removeItem("cart");
        window.location.href = `order-confirmation.html?id=${data.order._id}`;
      } else {
        alert(data.msg || "Order failed");
      }
    } catch (err) {
      console.error(err);
      alert("Error placing order");
    }
  }
</script>

<style>
.checkout-form{max-width:600px;margin:20px auto;display:flex;flex-direction:column;gap:12px;padding:20px;background:#fff;border-radius:8px}
.checkout-form input,.checkout-form select{padding:10px;border:1px solid #ccc;border-radius:6px}
.btn-add{background:#28a745;color:#fff;padding:12px;border-radius:6px;border:none;cursor:pointer}
.btn-add:hover{background:#218838}
</style>
  <footer class="site-footer">
  <p>© 2025 CareKart. All rights reserved.</p>
</footer>
</body>
</html>
