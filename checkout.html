<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout - CareKart</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">CareKart</a>
    <div class="titlebar">Safe medicines • Fast delivery</div>
  </div>
</header>

<main class="container">
  <a href="cart.html" class="back-arrow">← Back</a>
  <h1>Checkout</h1>

  <form id="checkoutForm" class="checkout-form">
    <h3>Shipping Information</h3>
    <input type="text" name="name" placeholder="Full Name" required>
    <input type="text" name="address" placeholder="Address" required>
    <input type="text" name="city" placeholder="City" required>
    <input type="text" name="state" placeholder="State" required>
    <input type="text" name="zip" placeholder="ZIP Code" required>
    <input type="text" name="phone" placeholder="Phone" required>

    <h3>Payment Method</h3>
    <select name="paymentMethod" required>
      <option value="cod">Cash on Delivery</option>
      <option value="card">Credit/Debit Card</option>
      <option value="upi">UPI</option>
    </select>

    <button type="submit" class="btn-add">Place Order</button>
  </form>
</main>

<script>
  const API_BASE = "https://pharmacy-oszy.onrender.com";

  const form = document.getElementById("checkoutForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const user = JSON.parse(localStorage.getItem("user") || "null");
    const token = localStorage.getItem("token");
    if (!user || !token) {
      alert("Please login to continue checkout.");
      window.location.href = "login.html";
      return;
    }

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    if (cart.length === 0) {
      alert("Your cart is empty.");
      return;
    }

    const shipping = Object.fromEntries(new FormData(form));
    const paymentMethod = shipping.paymentMethod;
    delete shipping.paymentMethod;

    // ✅ send only _id and quantity
    const items = cart.map(it => ({ id: it.id, quantity: it.quantity }));

    try {
      const res = await fetch(`${API_BASE}/api/orders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ items, shipping, paymentMethod })
      });

      const data = await res.json();
      if (data.ok) {
        localStorage.removeItem("cart");
        window.location.href = `order-confirmation.html?id=${data.order._id}`;
      } else {
        alert(data.error || data.msg || "Order failed");
      }
    } catch (err) {
      console.error(err);
      alert("Error placing order");
    }
  });
</script>
</body>
</html>
